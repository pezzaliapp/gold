<!DOCTYPE html>
<html lang="it" data-app="CSVXpressGold" data-ver="1.1.3">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CSVXpressGold</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.json?v=1.1.3">
  <meta name="theme-color" content="#0b1220">

  <!-- Styles (cache-bust reale) -->
  <link rel="stylesheet" href="style.css?v=1.1.3">

  <!-- Google Analytics 4 -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-QZ7CQDJX3E"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-QZ7CQDJX3E', { anonymize_ip: true });
  </script>

  <!-- Microsoft Clarity -->
  <script type="text/javascript">
    (function(c,l,a,r,i,t,y){
      c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
      t=l.createElement(r); t.async=1; t.src="https://www.clarity.ms/tag/"+i;
      y=l.getElementsByTagName(r)[0]; y.parentNode.insertBefore(t,y);
    })(window, document, "clarity", "script", "uy8owdlf8z");
  </script>
</head>

<body>
  <!-- ✅ Overlay errori (così niente “pagina marrone” muta) -->
  <div id="fatalOverlay" class="fatal" style="display:none;">
    <div class="fatal-card">
      <div class="fatal-title">Errore App</div>
      <div class="fatal-sub">Copia questo testo e incollamelo qui in chat.</div>
      <pre id="fatalText"></pre>
      <button type="button" onclick="location.reload()">Ricarica</button>
    </div>
  </div>

  <header data-zone="header">
    <div class="logo-container">
      <img src="icon/CSVXpressGold-1024.png" alt="CSVXpressGold Logo" class="logo">
      <div class="head-txt">
        <h1>CSVXpressGold</h1>
        <div class="sub">Preventivi Rivenditore & Cliente Finale — Margine + Noleggio</div>
        <div class="mini" id="verBadge" style="opacity:.70;margin-top:4px"></div>
      </div>
    </div>
  </header>

  <main>

    <!-- ✅ NUOVO: Anagrafica (opzionale) -->
    <section id="anagrafica-section" data-zone="anagrafica">
      <h2>Anagrafica (opzionale) — Rivenditore / Cliente Finale</h2>

      <div class="row">
        <label class="check" style="justify-content:flex-start;gap:10px;">
          <span class="mini" style="min-width:140px;">Compilo per:</span>
          <select id="anaTipo">
            <option value="riv" selected>Rivenditore</option>
            <option value="cli">Cliente Finale</option>
          </select>
        </label>
      </div>

      <div class="grid grid-2">
        <div>
          <label>Azienda</label>
          <input type="text" id="anaAzienda" placeholder="Ragione sociale">
        </div>
        <div>
          <label>Referente</label>
          <input type="text" id="anaReferente" placeholder="Nome e cognome">
        </div>

        <div>
          <label>Indirizzo</label>
          <input type="text" id="anaIndirizzo" placeholder="Via, n°, CAP, città, provincia">
        </div>
        <div>
          <label>Email</label>
          <input type="text" id="anaEmail" placeholder="email@azienda.it">
        </div>

        <div>
          <label>Cellulare</label>
          <input type="text" id="anaCell" placeholder="+39 ...">
        </div>
        <div>
          <label>P.IVA</label>
          <input type="text" id="anaPiva" placeholder="Partita IVA">
        </div>

        <div>
          <label>Codice Fiscale</label>
          <input type="text" id="anaCf" placeholder="Codice fiscale">
        </div>
        <div>
          <label>Note</label>
          <input type="text" id="anaNote" placeholder="Opzionale">
        </div>
      </div>

      <div class="row">
        <button id="btnAnaSave" type="button">Salva Anagrafica</button>
        <button id="btnAnaClear" type="button" class="secondary">Svuota</button>
      </div>

      <p class="hint">Non obbligatoria: l’app funziona anche senza compilare. Viene inserita automaticamente nel preventivo di stampa (Riv/Cliente).</p>
    </section>

    <section id="upload-section" data-zone="upload_csv">
      <h2>Carica Listino CSV</h2>
      <input type="file" id="csvFileInput" accept=".csv">
      <p class="hint">Colonne attese: Codice, Descrizione, PrezzoLordo, CostoTrasporto, CostoInstallazione</p>
      <p id="csvError" class="err" style="display:none;">Errore nel caricamento del file CSV.</p>

      <div class="row">
        <label class="check">
          <input type="checkbox" id="toggleCosti" checked>
          Popola automaticamente Trasporto e Installazione
        </label>

        <label class="check">
          <input type="checkbox" id="toggleMostraServizi" checked>
          Mostra Trasporto/Installazione nei report
        </label>
      </div>
    </section>

    <section id="listino-section" data-zone="selezione_listino">
      <h2>Filtra e Seleziona Articolo dal Listino</h2>
      <label for="searchListino">Cerca:</label>
      <input type="text" id="searchListino" placeholder="Inserisci codice o descrizione">
      <select id="listinoSelect"></select>

      <div class="row">
        <button id="btnAddFromListino" type="button">Aggiungi Articolo Selezionato</button>
        <button id="btnManual" type="button" class="secondary">Aggiungi Articolo Manualmente</button>
      </div>
    </section>

    <section id="articoli-section" data-zone="tabella_articoli">
      <h2>Articoli Aggiunti</h2>

      <div class="panel">
        <h3>Settaggi Preventivo</h3>
        <div class="grid">
          <div>
            <label>Margine Rivenditore % (default)</label>
            <input type="number" id="margineRivDefault" value="0" step="0.01" min="0">
            <div class="mini">Usato se la riga ha Margine% vuoto/0.</div>
          </div>

          <div>
            <label>Margine Cliente Finale % (default)</label>
            <input type="number" id="margineCliDefault" value="30" step="0.01" min="0">
            <div class="mini">Applicato al netto scontato (come margine).</div>
          </div>

          <div>
            <label>IVA %</label>
            <input type="number" id="ivaPerc" value="22" step="0.01" min="0">
            <div class="mini">Opzionale nei preventivi stampabili.</div>
          </div>

          <div class="checkline">
            <label class="check">
              <input type="checkbox" id="preventivoMostraIVA" checked>
              Mostra IVA nei preventivi
            </label>
            <label class="check">
              <input type="checkbox" id="preventivoPrezziUnitari" checked>
              Mostra prezzi unitari
            </label>
          </div>
        </div>
      </div>

      <table id="articoli-table" border="1">
        <thead>
          <tr>
            <th>Codice</th>
            <th>Descrizione</th>
            <th>Prezzo Lordo</th>
            <th>Sconto 1%</th>
            <th>Sconto 2%</th>
            <th>Margine %</th>
            <th>Netto</th>
            <th>Trasporto</th>
            <th>Installazione</th>
            <th>Q.tà</th>
            <th>Tot. Riv</th>
            <th>Venduto A €</th>
            <th>Diff</th>
            <th>Azioni</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <section id="totali-section" data-zone="totali">
      <div id="totaleGenerale"></div>
    </section>

    <section id="preventivi-section" data-zone="preventivi">
      <h2>Preventivi</h2>

      <div class="panel">
        <h3>Sconto Cliente Finale (calcolo inverso)</h3>

        <label class="check" style="display:block;margin:6px 0;">
          <input type="radio" name="scontoClienteMode" value="bene" checked>
          Calcola sconto sul solo bene (Prezzo Lordo di listino)
        </label>

        <label class="check" style="display:block;margin:6px 0;">
          <input type="radio" name="scontoClienteMode" value="totale">
          Calcola sconto sul totale (bene + trasporto + installazione)
        </label>

        <div class="mini">Il preventivo Cliente Finale mostrerà: Prezzo Lordo → Sconto% → Prezzo Finale.</div>
      </div>

      <div class="row">
        <button id="btnPrevRiv" type="button">Apri Preventivo Rivenditore (Stampa)</button>
        <button id="btnPrevCli" type="button">Apri Preventivo Cliente Finale (Stampa)</button>
      </div>
      <p class="hint">Su iPhone/iPad: Condividi → Stampa → Salva come PDF.</p>

      <div class="panel" id="noleggio-panel">
        <h3>Noleggio Operativo (simulazione)</h3>

        <div class="grid">
          <div>
            <label>Durata</label>
            <select id="noleggioDurata">
              <option value="12">12 mesi</option>
              <option value="18">18 mesi</option>
              <option value="24" selected>24 mesi</option>
              <option value="36">36 mesi</option>
              <option value="48">48 mesi</option>
              <option value="60">60 mesi</option>
            </select>
            <div class="mini">Calcolo su imponibile (totale senza IVA) del preventivo Cliente Finale.</div>
          </div>

          <div class="checkline">
            <label class="check">
              <input type="checkbox" id="noleggioMostraNelPreventivo" checked>
              Mostra box Noleggio nel preventivo stampabile
            </label>
            <label class="check">
              <input type="checkbox" id="noleggioMostraDettagli" checked>
              Mostra spese/€/giorno/€/ora
            </label>
          </div>
        </div>

        <div class="row">
          <div style="flex:1;min-width:260px">
            <div class="mini">Rata mensile</div>
            <div id="noleggioRata" style="font-size:20px;font-weight:700">—</div>
          </div>

          <div style="flex:1;min-width:260px">
            <div class="mini">Spese contratto</div>
            <div id="noleggioSpese" style="font-size:16px;font-weight:700">—</div>
          </div>

          <div style="flex:1;min-width:260px">
            <div class="mini">Costo giorno / ora</div>
            <div id="noleggioDayHour" style="font-size:14px;font-weight:700">—</div>
          </div>
        </div>

        <div class="row">
          <button id="btnNoleggioTXT" type="button" class="secondary">Scarica TXT Noleggio</button>
        </div>

        <p class="hint">Include: spese contratto + “Spese incasso RID: 4,00 € al mese” + testi benefici.</p>
      </div>
    </section>

    <section id="report-section" data-zone="report_export">
      <h2>Report Articoli</h2>
      <div class="row">
        <button id="btnWA" type="button">Invia Report su WhatsApp</button>
        <button id="btnTXT" type="button" class="secondary">Apri TXT Report</button>
      </div>

      <div class="row">
        <button id="btnWASenzaMargine" type="button">WhatsApp (senza Margine)</button>
        <button id="btnTXTSenzaMargine" type="button" class="secondary">Apri TXT (senza Margine)</button>
      </div>
    </section>

  </main>

  <!-- Librerie -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>

  <!-- App (cache-bust reale) -->
  <script src="app.js?v=1.1.3"></script>
</body>
</html>
